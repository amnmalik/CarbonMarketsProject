---
title: "Indian Carbon Markets"
author: "Aman Malik"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: true
    number_sections: true
    toc_float: true
    theme: united
editor_options: 
  chunk_output_type: console
---
<!-- # 1. Run NZ scenario on GCAM -->
<!-- # 2. Run batch file to get results of NZ run -->
<!-- # 3. Find sector specific emissions from NZ run -->
<!-- # 4.Edit sector constraint files -->
<!-- # 5. Run all scenarios on GCAM with constraints and batch file -->
<!-- # 6. Run batch files on GCAM results -->
<!-- # 7. Make plots based on results in last step -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F, cache = T)
```

```{r}
library(tidyverse)
library(ggsci)
library(ggpubr)
# library(hrbrthemes)
library(geomtextpath)
library(DT)
library(readxl)
library(ggrepel)
library(jgcricolors)
library(ggpattern)
```

# Setting palette
```{r}
mypal <- jgcricol()$pal_all
techs <- jgcricol()$pal_basic[c(1:3, 5)]
names(techs) <- c("Cement", "Fertilizer", "Iron and Steel", "Electricity")

kaya <- jgcricol()$pal_16[5:16]
names(kaya) <- c("Electricity generation", "GDP per capita", "transportation", "industry", "building", "CO2 emissions", "Emissions intensity (CO2/Energy)", "Energy intensity (Energy/GDP)","Shadow carbon price (non-ETS)","ETS","Shadow carbon price")

mypal <- c(kaya, techs, mypal, "delivered biomass" = "darkolivegreen2", "delivered coal" = "black", "H2" = "peachpuff2", "refined liquids industrial" = "#d01c2a","NZ"="#fc8d59","NZ+ETS"="#beaed4","NZ+CC"="#7fc97f","NZ+CC_v2"="#7fc97f","NZ+RPO+ETS"="#1f78b4","delivered coal+CCS"="#8E8E8E","coal CCS"="gray40","biomass CCS"="darkolivegreen1","gas CCS"="darkslategray1")

names(mypal) <- gsub(names(mypal),pattern = "Ccs",replacement = "CCS")
```


# Scenario constraints
```{r}
gcamScen <- read_csv("data/scenario_constraints.csv", show_col_types = FALSE) %>%
  # select(-16) %>%
  pivot_longer(`2015`:`2070`, names_to = "year", values_to = "value")

ggplot() +
  geom_line(gcamScen %>% filter(sector != "TOTAL", scenario != "BAU"),
    mapping = aes(
      x = year, y = value * 3.667,
      color = scenario, group = scenario
    )
  ) +
  facet_wrap(~sector, scales = "free") +
  scale_color_lancet() +
  theme_bw() +
  theme(
    legend.position = "right",
    legend.margin = margin(0, 0, 0, 0),
    axis.text.x = element_text(size = 7, angle = 45, vjust = 0.8, hjust = 0.8)
  ) +
  labs(x = "", y = "Emissions (MTCO2)", subtitle = "Emission cap in each of the four considered ETS sectors") +
  theme(strip.background = element_blank())

ggsave("output_plots/sectors_caps.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

gcamScenTot <- gcamScen %>%
  group_by(scenario, year) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  mutate(
    scenario = gsub(scenario, pattern = "CC", replacement = "ETS"),
    year = as.numeric(year)
  ) %>%
  filter(scenario %in% c("BAU", "ETS")) %>%
  as_tibble()

ggplot() +
  geom_line(
    data = gcamScenTot %>% filter(scenario == "ETS"),
    mapping = aes(x = year, y = value * 3.667, color = scenario)
  ) +
  scale_color_lancet() +
  theme_bw(base_size = 10) +
  theme(
    text = element_text(size = 12), legend.position = c(0.85, 0.8), legend.justification = c(0, 0),
    axis.text.x = element_text(size = 10, angle = 0, vjust = 0, hjust = 0.5)
  ) +
  labs(
    x = "", y = "Emissions (MTCO2)",
    subtitle = "Total emissions cap across the four considered ETS sectors"
  )

ggsave("output_plots/emissions_cap.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```


## Get results from GCAM runs
```{r}
# Load and Display data from GCAM scenarios
### Using three  different query files because of different years

#data_folder="data/modelling_results_2023_03_16/"
data_folder = "data/modelling_results_2023_04_17/"

Final_results <- read_excel(paste0(data_folder,"Final_results.xls")) %>%
  filter(title != "title") %>%
  mutate(across(c(`1990`:`2095`), as.numeric)) %>%
  mutate(across(c(`1990`:`2095`), ~ round(., digits = 2))) %>%
  pivot_longer(`1990`:`2095`, names_to = "year", values_to = "value")



Final_results_CP <- read_excel(paste0(data_folder,"Final_results_cp+fe.xls")) %>%
  filter(title != "title") %>%
  mutate(across(c(`1990`:`2100`), as.numeric)) %>%
  mutate(across(c(`1990`:`2100`), ~ round(., digits = 2))) %>%
  pivot_longer(`1990`:`2100`, names_to = "year", values_to = "value") %>%
  rename("sector" = market)



Final_results_CO2 <- read_excel(paste0(data_folder,"Final_results_CO2.xls")) %>%
  filter(title != "title") %>%
  mutate(across(c(`1990`:`2095`), as.numeric)) %>%
  mutate(across(c(`1990`:`2095`), ~ round(., digits = 2))) %>%
  pivot_longer(`1990`:`2095`, names_to = "year", values_to = "value") %>%
  mutate(sector = if_else(title == "GDP per capita MER by region", "GDP per capita", if_else(title == "elec gen by region (incl CHP)", "Electricity generation", "CO2 emissions")))


all_data <-
  bind_rows(Final_results, Final_results_CP, Final_results_CO2) %>%
  separate(
    col = scenario,
    into = c("scenario", "date"),
    sep = ",",
    remove = T
  ) %>%
  select(-date) %>%
  mutate(scenario = gsub(
    x = scenario,
    pattern = "India_",
    replacement = ""
  )) %>%
  mutate(scenario = factor(
    scenario,
    levels = c(
      "NZ",
      "NZ+ETS",
      "NZ+CC",
      "NZ+RPO+ETS",
      "NZ+CC_v1",
      "NZ+CC_v2"
    )
  ))


unique(all_data$scenario)


#### Renaming sector names in GCAM
all_data <- all_data %>%
  mutate(
    sector = mgsub::mgsub(sector,
      pattern = c("iron and steel", "cement", " N fertilizer", "aluminum", "alumina", "refining", "electricity", "N fertilizer"),
      replacement = c("Iron and Steel", "Cement", "Fertilizer", "Aluminium", "Aluminium", "Petroleum Refinery", "Electricity", "Fertilizer")
    )
  )

common <- c("Cement", "Fertilizer", "Iron and Steel", "Electricity")
```

# Demand drivers
```{r}
# growth in gdp emissions, FE,
ref_scen <- all_data %>%
  filter(title %in% c(
    "GDP per capita MER by region",
    "total final energy by aggregate sector",
    "elec gen by region (incl CHP)"
  ))

ref_scen_2015 <- ref_scen %>% filter(year == 2015)

ref_join <- left_join(ref_scen, ref_scen_2015, by = c("sector", "scenario", "title", "Units", "region")) %>%
  mutate(
    growth = value.x / value.y,
    sector = gsub(sector, pattern = "GDP per capita MER by region", replacement = "GDP per capita"),
    year.x = as.numeric(year.x)
  ) %>%
  select(-year.y) %>%
  filter(scenario == "NZ", year.x %in% c(2015:2070)) %>%
  mutate(label = if_else(year.x == 2070, sector, NA_character_))

ggplot(ref_join, mapping = aes(x = year.x, y = growth, color = sector, group = sector)) +
  geom_line(linewidth = 1.5, show.legend = F) +
  geom_label_repel(aes(label = label),
    nudge_x = 10, box.padding = 0.3, direction = "y",
    na.rm = TRUE, show.legend = F
    #   arrow = arrow(length = unit(0.015, "npc"))
  ) +
  annotate("text",
    x = 2015, y = 10,
    label = "GDP per capita|2015 : 1691 USD", hjust = 0, vjust = 0
  )+
  annotate("text", x = 2015, y = 9, label = "Elec Gen.|2015 : 1375 TWh", hjust = 0, vjust = 0) +
  annotate("text", x = 2015, y = 8, label = "FE Buildings|2015 : 8.6 EJ", hjust = 0, vjust = 0) +
  annotate("text", x = 2015, y = 7, label = "FE Industry|2015 : 11.85 EJ", hjust = 0, vjust = 0) +
  annotate("text", x = 2015, y = 6, label = "FE Transport|2015 : 4.01 EJ", hjust = 0, vjust = 0) +
  scale_color_manual(values = mypal[names(mypal) %in% unique(ref_join$sector)]) +
  coord_cartesian(ylim = c(1, 12)) +
  labs(x = "", y = "Change (relative to 2015)") +
  theme_pubclean(base_size = 14) +
  scale_x_continuous(breaks = seq(2020, 2070, by = 10))


ggsave("output_plots/ref_scenario.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```

# Kaya identity

```{r}
# Population
# GDP per capita
# CO2 emissions
# Carbon Intensity
# Energy Intensity
# Carbon Intensity

pop <- all_data %>%
  filter(title == "population by region")
gdp <- all_data %>%
  filter(title == "GDP MER by region")

gdpPerCap <- all_data %>%
  filter(title == "GDP per capita MER by region") %>%
  mutate(title = "GDP per capita")

tot_em <- all_data %>%
  filter(sector == "CO2 emissions") %>%
  mutate(title = "CO2 emissions")

pe <- all_data %>%
  filter(title == "primary energy consumption by region (direct equivalent)") %>%
  group_by(title, scenario, year, Units, region) %>%
  summarise(value = sum(value)) %>%
  mutate(title = "total primary energy") %>%
  ungroup()

carbon_intensity <- left_join(tot_em, pe, by = c("scenario", "year", "region")) %>%
  mutate(value = value.x / value.y) %>%
  mutate(title = "Emissions intensity (CO2/Energy)") %>%
  select(title, year, value, scenario)

en_intensity <- left_join(pe, gdp, by = c("scenario", "year", "region")) %>%
  mutate(title = "Energy intensity (Energy/GDP)") %>%
  mutate(value = value.x / value.y) %>%
  select(title, year, value, scenario)



kaya <- gdpPerCap %>%
  bind_rows(tot_em) %>%
  bind_rows(carbon_intensity) %>%
  bind_rows(en_intensity) %>%
  filter(scenario == "NZ")
kaya_ref <- kaya %>% filter(year == "2015")

kaya2 <- left_join(kaya, kaya_ref, by = c("title", "scenario", "sector", "Units")) %>%
  mutate(
    value = value.x / value.y,
    value = round(value, 2)
  )

ggplot(kaya2 %>% filter(year.x > 2010, year.x < 2075)) +
  geom_line(mapping = aes(x = year.x, y = value, color = title, group = title), linewidth = 1.5) +
  theme_pubclean() +
  scale_color_manual(values = mypal[names(mypal) %in% unique(kaya2$title)]) +
  labs(x = "", y = "Change rel. to 2015", subtitle = "Drivers of emission change: Kaya identity") +
  theme(legend.position = c(0.25, 0.8), legend.title = element_blank(), legend.box.background = element_rect(colour = "black"))

ggsave("output_plots/kaya.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```

# NZ scenario emissions and production
```{r}
## Emissions
em_sec_nz <- all_data %>%
  filter(
    sector %in% common,
    title %in% grep(x = title, pattern = "emissions by sector", value = T),
    scenario == "NZ"
  ) %>%
  mutate(category = "Emissions (MtCO2)")

# Production
prod_nz <- all_data %>%
  filter(title %in% grep(
    x = title,
    pattern = "production",
    value = T
  ), scenario == "NZ")

# Separate electricity generation
elec_gen_nz <- all_data %>%
  mutate(year = as.numeric(year)) %>%
  filter(title == "elec gen by subsector", scenario == "NZ") %>%
  group_by(title, scenario, region, Units, year) %>%
  summarise(value = sum(value)) %>%
  mutate( # value=value*277.78,Units="TWh",
    year = as.character(year), sector = "Electricity"
  )



# combining production and elec generation
prod_tot <- bind_rows(prod_nz, elec_gen_nz) %>%
  mutate(category = "Production (Mt or EJ)")

# Combining emissions and production quantities
overall <- bind_rows(em_sec_nz, prod_tot)


a <- ggplot(overall %>% filter(year < 2075, year > 2010, sector != "Aluminium")) +
  geom_line(aes(x = year, y = value, color = category, group = category),linewidth=1.5) +
  facet_wrap(~sector, scales = "free") +
  theme_pubclean(base_size = 11) +
  labs(
    x = "", y = "Production and emissions (MTCO2)", color = "",
  ) +
  scale_color_lancet() +
  theme(legend.position = "top", axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8),strip.text = element_text(size=8),legend.text = element_text(size = 11))

ggsave("output_plots/prod_emiss_nz.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)

elec_gen_tech_nz <- all_data %>%
  mutate(year = as.numeric(year)) %>%
  filter(title == "elec gen by subsector", scenario == "NZ") %>%
  # distinct() %>%
  pivot_wider(names_from = sector, values_from = value) %>%
  mutate(`solar` = `solar` + `rooftop_pv`) %>%
  select(-`rooftop_pv`) %>%
  pivot_longer(cols = `biomass`:`wind`, names_to = "sector", values_to = "value")

b <- ggplot() +
  geom_area(
    elec_gen_tech_nz %>% filter(
      year < 2075, year > 2005,
      !sector %in% c("geothermal", "refined liquids")
    ),
    mapping = aes(x = year, y = value, fill = sector, group = sector)
  ) +
  scale_fill_manual(values = mypal[names(mypal) %in% unique(elec_gen_tech_nz$sector)]) +
  theme_pubclean() +
  theme(legend.position = "top") +
  guides(fill = guide_legend(nrow = 2)) +
  labs(
    x = "",
    # subtitle = "Electricity generation by sector (EJ)",
    y = "Electricity generation (EJ)",
    fill = ""
  ) +
  scale_x_continuous(breaks = seq(2010, 2070, by = 10))




# c <- ggplot(em_sec_nz %>% filter(sector == "Electricity", year < 2075, year > 2005)) +
#   geom_line(aes(x = year, y = value * 3.667, color = sector, group = sector), show.legend = F) +
#   scale_color_lancet() +
#   theme_bw() +
#   labs(
#     x = "",
#     #  y = "Emissions (MTCO2)",
#     y = "",
#     subtitle = "Electricity sector emissions (MTCO2)"
#   ) +
#   theme(axis.text.x = element_text(size = 7, angle = 45, vjust = 0.8, hjust = 0.8))

library(patchwork)
a | (b)

ggsave("output_plots/pathwork_emissions_production.png",
  device = "png", dpi = "print",
  width = 9, height = 6
)
```

# Total emissions
```{r}
tot_em <- all_data %>% filter(sector == "CO2 emissions", year < 2075, scenario %in% c("NZ","NZ+RPO+ETS","NZ+ETS"))                               

ggplot(tot_em %>% filter(year > 2010,scenario!="NZ+CC")) +
  geom_line(
    mapping = aes(
      x = year,
      y = value * 3.667,
      color = scenario,
      group = scenario
    ),linewidth=1.5
  ) +
  geom_point(aes(
    x = year,
    y = value * 3.667,
    shape = scenario,
    color = scenario,
    group=scenario
  ),show.legend = F,size=2.5) +
  theme_pubclean(base_size = 14) +
   scale_color_manual(values = mypal[names(mypal) %in% unique(tot_em$scenario)]) +
  labs(x = "", y = "Total Emissions (MTCO2)")+
  theme(legend.text = element_text(size = 14))

ggsave("output_plots/tot_emissions_new.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```

# Share of emission reduction
```{r}
em_sec_share <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T), sector %in% common) %>%
  mutate(value = if_else(scenario %in% c("NZ+RPO+ETS", "NZ+CC_v1", "NZ+ETS", "NZ+CC", "NZ+CC_v2"), value / 2, value)) %>%
  filter(scenario %in% c("NZ", "NZ+ETS", "NZ+CC","NZ+CC_v2","NZ+RPO+ETS"))

em_sec_share_tot <- em_sec_share %>%
  filter(year > 2025) %>%
  group_by(scenario, Units, year, sector) %>%
  summarise(value = sum(value)) %>%
  pivot_wider(names_from = scenario, values_from = value) %>%
  mutate(
    `NZ+ETS` = `NZ+ETS` - `NZ`,
    `NZ+CC` = `NZ+CC` - `NZ`,
    `NZ+RPO+ETS` = `NZ+RPO+ETS` - `NZ`
  ) %>%
  select(Units, year, sector, `NZ+ETS`, `NZ+CC`,`NZ+RPO+ETS`) %>%
  pivot_longer(cols = c(4:6), names_to = "scenario", values_to = "value")%>%
  group_by(Units,year,scenario) %>%
  summarise(value=sum(value))

ggplot(em_sec_share_tot %>% filter(scenario %in% c( "NZ+RPO+ETS","NZ+ETS"), year < 2075,year==2030)) +
  geom_col(mapping = aes(x = year, y = value*3.667, fill = scenario),position = position_dodge(1),show.legend = F)+ 
  theme_pubclean()+
  scale_fill_manual(values = mypal[names(mypal) %in% unique(em_sec_share_tot$scenario)]) +
  labs(x = "", y = "Emission reductions (MTCO2)", caption = "Results for 2030")+
    theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())

ggsave("output_plots/tot_em_red_ETSvsRPO.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)


ggplot(em_sec_share_tot %>% filter(scenario == "NZ+RPO+ETS", year < 2075)) +
  geom_col(mapping = aes(x = year, y = value, fill = sector))+ 
  theme_bw()+ 
  scale_fill_manual(values = mypal[names(mypal) %in% unique(em_sec_share_tot$sector)]) +
  labs(x = "", y = "Emissions (MTCO2)", subtitle = "Absolute emission reduction in NZ+ETS vs. NZ scenario")
# facet_wrap(~scenario)

ggplot(em_sec_share_tot %>% filter(scenario %in% c("NZ+ETS","NZ+RPO+ETS"), year==2030) %>% mutate(sector = factor(sector,levels=c("Electricity","Iron and Steel","Cement","Fertilizer"))))+
   geom_col_pattern( mapping = aes(x = year, y = value*3.667, fill = sector,pattern=scenario,group=interaction(scenario,sector)),position = position_dodge(1),pattern_angle = 45,
                   pattern_density = 0.1,
                   pattern_spacing = 0.025,
                   color = "black", 
                   pattern_fill = "black")+
    facet_grid(~sector)+
    scale_pattern_manual(values = c(`NZ+RPO+ETS` = "stripe", `NZ+ETS` = "none"),labels=c("Emission reduction (ETS only)","Emission reduction(ETS with RPO)" ))+
  # scale_pattern_manual(values = c(`NZ+RPO+ETS` = "stripe", `NZ+ETS` = "none"),labels=c("Required emission reduction\nunder BEE-based allocation regime","Actual emissions reduction\nfrom ETS compared to baseline" ))+
  theme_pubclean()+
  labs(x="",y="Emission reduction wrt baseline (MTCO2)",fill="",pattern="",caption = "Results for year 2030")+
 guides(fill="none")+
  guides(pattern = guide_legend(override.aes = list(fill = "white")))+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank())+
  scale_fill_manual(values = mypal[names(mypal) %in% unique(em_sec_share_tot$sector)]) 

ggsave("output_plots/abs_emiss_red2.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```

# Total mitigation cost
```{r}

em_sec_share_tot <- em_sec_share %>%
  filter(year > 2025) %>%
  group_by(scenario, Units, year, sector) %>%
  summarise(value = sum(value)) %>%
  pivot_wider(names_from = scenario, values_from = value) %>%
  mutate(
    `NZ+ETS` = `NZ+ETS` - `NZ`,
    `NZ+CC` = `NZ+CC` - `NZ`,
    `NZ+CC_v2` = `NZ+CC_v2` - `NZ`
  ) %>%
  select(Units, year, sector, `NZ+ETS`, `NZ+CC`,`NZ+CC_v2`) %>%
  pivot_longer(cols = c(4:6), names_to = "scenario", values_to = "value")

Cprices <- all_data %>%
  filter(title == "CO2 prices",scenario %in% c("NZ+ETS","NZ+CC_v2")) %>%
  mutate(value = (value * 1.98) / 3.667, Units = "2020$/tCO2") %>% 
  mutate(sector = mgsub::mgsub(sector,pattern = c("IndiaCO2Elec","IndiaCO2Fert","IndiaCO2IRSTL","IndiaCO2Cement"),replacement = c("Electricity","Fertilizer","Iron and Steel","Cement")))
  
mit_cost_cc <- left_join(em_sec_share_tot %>% filter(scenario=="NZ+CC_v2"),Cprices %>% filter(scenario=="NZ+CC_v2",sector!="IndiaCO2"),by=c("scenario","year","sector")) %>% 
  filter(year<2045) %>% mutate(cost=value.x*value.y*-3.67) %>% 
  group_by(scenario,year) %>% 
  summarise(value=sum(cost))

mit_cost_ets <- left_join(em_sec_share_tot %>% filter(scenario=="NZ+ETS"),Cprices %>% filter(scenario=="NZ+ETS",sector!="IndiaCO2"),by=c("scenario","year")) %>% 
  filter(year<2045) %>% mutate(cost=value.x*value.y*-3.67) %>% 
    group_by(scenario,year) %>% 
  summarise(value=sum(cost))

mit_cost <- bind_rows(mit_cost_cc,mit_cost_ets)

ggplot(mit_cost)+
  geom_col(mapping = aes(x=year,y=value/1000,fill=scenario),position = position_dodge())+
  theme_pubclean(base_size = 14)+ 
   scale_fill_manual(values = mypal[names(mypal) %in% unique(mit_cost$scenario)]) +
  labs(x = "", y = "Mitigation cost (billion USD)", subtitle = "",fill="")+
  theme(legend.text = element_text(size = 14))+
  geom_text(mapping = aes(x=year,y=value/1000,label = round(value/1000,1),group=scenario), size = 4,vjust=-0.1,position =  position_dodge(width = 0.9)) 



ggsave("output_plots/mit_cost.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```



# Emissions by industry sector
```{r}
em_sec <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T)) %>%
  mutate(value = if_else(scenario != "NZ", value / 2, value))

ggplot() +
  geom_line(em_sec %>% filter(sector %in% common, year > 2020, year < 2075, scenario %in% c("NZ", "NZ+ETS","NZ+CC")),
    mapping = aes(x = year, y = value * 3.667, group = scenario, color = scenario),linewidth=1.5
  ) +
  geom_point(em_sec %>% filter(sector %in% common, year > 2020, year < 2075, scenario %in% c("NZ","NZ+ETS","NZ+CC")),
    mapping = aes(
      x = year,
      y = value * 3.667,
      shape = scenario,
      color = scenario
    ),size=2.5,show.legend = F
  ) +
  facet_wrap(~sector, shrink = T, scales = "free") +
 scale_color_manual(values = mypal[names(mypal) %in% unique(em_sec$scenario)]) +
  theme_pubclean(base_size = 12) +
  labs(x = "", y = "Emissions (MTCO2)") +
  theme(legend.position = "top", axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8),strip.text = element_text(size=14),legend.text = element_text(size = 14),legend.title = element_blank())

ggsave("output_plots/sec_emissions_new.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

# Emissions by sector relative to NZ

tot_em <- all_data %>%
  filter(title == "CO2 emissions by region") %>%
  mutate(value = value * 3.667) %>%
  mutate(sector = "Total CO2 emissions")

combined <- bind_rows(tot_em, em_sec)

# em_sec_nz <- combined %>% filter(scenario=="NZ")
em_sec_nz <- combined %>% filter(scenario == "NZ")
em_sec_join <- left_join(combined, em_sec_nz, by = c("title", "sector", "region", "year")) %>%
  mutate(change = value.x / value.y, label = scenario.x)




ggplot(em_sec_join %>% filter(
  sector != "Petroleum Refinery", sector %in% common, year > 2015, year < 2055, scenario.x %in% c("NZ", "NZ+ETS", "NZ+CC")
)) +
  geom_textline(mapping = aes(x = year, y = change, label = label, color = label, group = scenario.x), vjust = 0.2, rich = TRUE, size = 3, show.legend = F,linewidth=1.5) +
  facet_wrap(~sector) +
 scale_color_manual(values = mypal[names(mypal) %in% unique(em_sec_join$label)]) +
  theme_pubclean(base_size = 14) +
  labs(x = "", y = "", subtitle = "Sector emissions relative to NZ")+
  theme(legend.text = element_text(size = 14),strip.text = element_text(size = 14))

ggsave("output_plots/sec_emissions_nz_relative2.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```
# MACC for NZ+CC scenarios
```{r}
macc <-  all_data %>%
  filter(title == "CO2 prices") %>%
  mutate(value = (value * 1.98) / 3.667, Units = "2020$/tCO2") %>% 
  mutate(sector =gsub(sector,pattern = "IndiaCO2",replacement = "")) %>% 
  mutate(sector=if_else(scenario=="NZ",gsub(sector,pattern = "",replacement = "CO2"),sector)) %>% 
  mutate(sector=gsub(sector,pattern = "NONETSAll",replacement = "Non-ETS"),
    sector = mgsub::mgsub(sector, pattern = c("Elec", "Fert", "IRSTL"), replacement = c("Electricity", "Fertilizer", "Iron and Steel"
  )))

macc <- macc %>% filter(scenario =="NZ+CC")

em_sec <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T),scenario=="NZ+CC") %>%
  mutate(value = if_else(scenario != "NZ", value / 2, value)) %>% 
  mutate(value=value*3.67)

join <- left_join(macc,em_sec,by=c("scenario","year","sector")) %>% filter(year>2020,year<2070,sector!="Non-ETS")

AM_MACC <- read_excel("AM-MACC.xls") %>% 
  pivot_longer(`2030`:`2070`,names_to = "year",values_to = "value") %>% filter(scenario %in% c("Difference","Co2 price","Co2 price_noNetZero")) %>% select(-1)

join <- left_join(AM_MACC %>% filter(scenario=="Difference"),
                  AM_MACC %>% filter(scenario=="Co2 price"),by=c("year","sector")
                  )

join <- left_join(join,AM_MACC %>% filter(scenario=="Co2 price_noNetZero"))

ggplot()+
  geom_line(join %>% filter(year<2070),mapping = aes(x=value.x,y=value.y,color=sector))+
  labs(x="Emission reduction (MTCO2)",y="CO2 price($2020/tCO2)")+
  coord_cartesian(ylim = c(0,2000))+
  theme_pubclean()+
  labs(subtitle = "Emission reduction (No_constraint - NZ+CC)")

ggplot()+
  geom_line(join %>% filter(year<2070),mapping = aes(x=value.x,y=value,color=sector))+
  labs(x="Emission reduction (MTCO2)",y="CO2 price($2020/tCO2)")+
  coord_cartesian(ylim = c(0,2000))+
  theme_pubclean()+
  labs(subtitle = "Emission reduction (No_constraint - CC(no Net zero goal))")

ggsave("output_plots/sector_macc.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

```




# Emissions by sector - INDEXED to 2020
```{r}
em_sec <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T)) %>%
  mutate(value = if_else(scenario %in% c("NZ+RPO+ETS", "NZ+CC_v1", "NZ+CC_v2", "NZ+ETS", "NZ+CC"), value / 2, value))

em_sec_2020 <- em_sec %>%
  filter(year == 2020)

em_joined <- left_join(em_sec, em_sec_2020, by = c("sector", "scenario", "title", "Units")) %>%
  mutate(value = value.x / value.y, year = year.x) %>%
  select(sector, scenario, year, value) %>%
  distinct() %>%
  mutate(year = as.numeric(year))

ggplot(em_joined %>% filter(year %in% c(2020:2070), sector %in% common)) +
  geom_line(mapping = aes(x = year, y = value, color = scenario, group = scenario)) +
  facet_wrap(~sector) +
  scale_color_lancet() +
  theme_bw() +
  labs(x = "", y = "Total emissions (indexed to 2020)", color = "") +
  theme(strip.background = element_blank())

ggsave("output_plots/sec_emissions_indexed.png",
  device = "png", dpi = "print",
  width = 9, height = 5
)
```
# Total ETS emissions
```{r}
em_sec <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T)) %>%
  mutate(value = if_else(scenario %in% c("NZ+RPO+ETS", "NZ+CC_v1", "NZ+CC_v2", "NZ+ETS", "NZ+CC"), value / 2, value))

em_sec_tot <- em_sec %>% filter(sector %in% common) %>% 
  group_by(scenario,year) %>% 
    summarise(value=sum(value))

ggplot()+
  geom_line(em_sec_tot %>% filter(scenario %in% c("NZ","NZ+ETS","NZ+CC"),year<2075,year>2010),mapping = aes(x=year,y=value,group=scenario,color=scenario))+
   scale_color_manual(values = mypal[names(mypal) %in% unique(em_sec_tot$scenario)]) +
  theme_pubclean()+
  labs(x="",y="Emissions ETS sectors (MTCO2)")

ggplot(em_sec_tot %>% filter(scenario %in% c("NZ","NZ+ETS"),year==2040))+
  geom_col(mapping = aes(x= year, y=value*3.667,fill=scenario),position = "dodge",show.legend = F)+
   scale_fill_manual(values = mypal[names(mypal) %in% unique(em_sec_tot$scenario)]) +
  theme_pubclean(base_size = 14) +
  labs(x = "", y = "ETS Emissions (MTCO2)",fill="")+
  theme(legend.text = element_text(size = 14),strip.text = element_text(size = 14))+
  geom_text(mapping = aes(x= year, y=value*3.667,group=scenario,label=round(value*3.667,0)),vjust=0.1,position = position_dodge(width=0.9))

ggsave("output_plots/tot_cap_ets_old.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

```



# Total and sector emissions together
```{r}
tot_em <- all_data %>% filter(sector == "CO2 emissions", year < 2075)

em_sec <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T)) %>%
  mutate(value = if_else(scenario != "NZ", value / 2, value))

combined <- bind_rows(tot_em, em_sec) %>%
  filter(sector != "refining", year > 2015, year < 2075) %>%
  mutate(sector = factor(sector, levels = c("CO2 emissions", unique(em_sec$sector))))


ggplot(combined %>% filter(sector %in% c(common, "CO2 Emissions"))) +
  geom_line(mapping = aes(x = year, y = value * 3.667, group = scenario, color = scenario)) +
  geom_point(aes(
    x = year,
    y = value * 3.667,
    shape = scenario,
    color = scenario
  )) +
  facet_wrap(~sector, scales = "free", ncol = 2, shrink = T) +
  geom_vline(combined %>% filter(sector %in% c(common, "CO2 Emissions")), mapping = aes(xintercept = "2040"), linetype = "dashed") +
 scale_color_manual(values = mypal[names(mypal) %in% unique(combined$scenario)]) 
  labs(x = "", y = "Emissions (MTCO2)") 

ggsave("output_plots/patchwork_emissions.png",
  device = "png", dpi = "print",
  width = 10, height = 6
)
```



# Fossil carbon intensity in electricity sector
```{r eval=FALSE, include=FALSE}
fossil_emissions <- all_data %>%
  filter(title == "CO2 emissions by sector: TPP") %>%
  filter(sector %in% c("coal", "gas")) %>%
  # mutate(value = if_else(scenario %in% c("NZ+RPO+ETS", "NZ+RPO+CC", "NZ+ETS", "NZ+CC"), value / 2, value)) %>%
  mutate(value = value * 3.667 * 1000000000, Units = "kgCO2") %>%
  group_by(scenario, year, Units) %>%
  summarise(value = sum(value)) %>%
  ungroup()

fossil_generation <- elec_gen_share <- all_data %>%
  filter(title == "elec gen by subsector") %>%
  filter(sector %in% c("coal", "gas")) %>%
  mutate(value = value * 277.78 * 1000000000, Units = "KWh") %>%
  group_by(scenario, year, Units) %>%
  summarise(value = sum(value)) %>%
  ungroup()

FCI <- left_join(fossil_generation, fossil_emissions, by = c("scenario", "year")) %>% mutate(FCI = value.y / value.x)

ggplot(FCI %>% filter(year %in% c(2020, 2040))) +
  geom_col(aes(x = scenario, y = FCI, fill = scenario)) +
  facet_wrap(~year) +
  labs(
    subtitle = "Fossil (coal and gas) Carbon Intensity (kgCO2/KWh)",
    x = "",
    y = ""
  ) +
  theme_bw() +
  scale_fill_aaas() +
  theme(axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8))

ggsave("output_plots/FCI.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```

# Electricity generation mix
```{r}
elec_gen_share <- all_data %>%
  mutate(year = as.numeric(year)) %>%
  filter(title == "elec gen by subsector", year > 2015, year < 2075) %>%
  pivot_wider(names_from = sector, values_from = value) %>%
  mutate(`solar` = `solar` + `rooftop_pv`) %>%
  select(-`rooftop_pv`) %>%
  pivot_longer(cols = `biomass`:`wind`, names_to = "sector", values_to = "value") %>%
  group_by(scenario, year) %>%
  mutate(percent = value / sum(value), percent = percent * 100)

ggplot(elec_gen_share %>% filter(year %in% c(2020, 2050, 2070), !sector %in% c("refined liquids", "geothermal"), scenario %in% c("NZ", "NZ+ETS"))) +
  geom_bar(mapping = aes(x = scenario, y = percent, fill = sector), stat = "identity") +
  facet_grid(. ~ year) +
  scale_fill_manual(values = mypal[names(mypal) %in% unique(elec_gen_share$sector)]) +
  theme_pubclean(base_size = 14) +
  labs(x = "", y = "Share of electricity generation by source (%)", fill = "") +
  theme(axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8),legend.text = element_text(size = 14))

ggsave("output_plots/elec_mix_comp2.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

elec_gen_by_tech  <- all_data %>%
  mutate(year = as.numeric(year)) %>%
  filter(title == "elec gen by tech", year > 2015, year < 2075) %>% 
  group_by(scenario, year) %>%
  mutate(percent = value / sum(value), percent = percent * 100)

ggplot(elec_gen_by_tech %>% filter(year %in% c(2030, 2050),!sector %in% c("refined liquids", "geothermal"),scenario %in% c("NZ+ETS","NZ+RPO+ETS"))) +
  geom_bar(mapping = aes(x = scenario, y = percent, fill = sector), stat = "identity") +
  facet_grid(. ~ year)+
  scale_fill_manual(values = mypal[names(mypal) %in% unique(elec_gen_by_tech$sector)])+
  theme_pubclean(base_size = 14) +
  labs(x = "", y = "Share of electricity generation by source (%)", fill = "") +
  theme(axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8),legend.text = element_text(size = 14))

ggsave("output_plots/elec_mix_comp_CCS_new.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

```

# Primary energy mix
```{r}
pe <- all_data %>%
  filter(title == "primary energy consumption by region (direct equivalent)", year > 2010, year < 2075) %>%
  group_by(scenario, year) %>%
  mutate(percent = value / sum(value), percent = percent * 100)

ggplot(pe %>% filter(year %in% c(2020, 2030, 2050, 2070))) +
  geom_bar(mapping = aes(x = scenario, y = percent, fill = sector), stat = "identity") +
  facet_grid(. ~ year) +
  scale_fill_manual(values = mypal[names(mypal) %in% unique(pe$sector)]) +
  theme_bw() +
  labs(x = "", y = "Share of primary energy (%)", fill = "category") +
  scale_y_continuous(sec.axis = dup_axis(name = "")) +
  theme(axis.text.x = element_text(size = 6, angle = 45, vjust = 0.8, hjust = 0.8))

ggsave("output_plots/pe_mix.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```

# CO2 prices
```{r}
Cprices <- all_data %>%
  filter(title == "CO2 prices") %>%
  mutate(value = (value * 1.98) / 3.667, Units = "2020$/tCO2") %>% 
  mutate(sector =gsub(sector,pattern = "IndiaCO2",replacement = "")) %>% 
  mutate(sector=if_else(scenario=="NZ",gsub(sector,pattern = "",replacement = "CO2"),sector)) %>% 
  mutate(sector=gsub(sector,pattern = "NONETSAll",replacement = "Non-ETS"),
    sector = mgsub::mgsub(sector, pattern = c("Elec", "Fert", "IRSTL"), replacement = c("Electricity", "Fertilizer", "Iron and Steel"
  )))


ggplot(Cprices %>% filter(scenario %in% c("NZ+ETS","NZ+RPO+ETS"),sector=="ETS",year > 2020, year < 2050))+
  geom_line(mapping = aes(x = year, y = value, group = scenario, color = scenario),linewidth=1.5)+ scale_color_manual(values = mypal[names(mypal) %in% unique(Cprices$scenario)]) +
  theme_pubclean() +
  labs(x = "", y = "CO2 Price (2020$/tCO2)",color="",caption = "Results only shown until 2045")

ggsave("output_plots/Co2price_rpoVSets.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

p1 <- ggplot(Cprices %>% filter(year > 2015, year < 2070, scenario %in% c("NZ+ETS"),	sector=="ETS")) +
  geom_line(mapping = aes(x = year, y = value, group = sector, color = sector),linewidth=1.5)+
  # geom_point(mapping = aes(x=year,y=value,group = scenario,shape=sector,color=sector),show.legend = F)+
  facet_wrap(~scenario, shrink = T, scales = "free") +
  scale_color_manual(values = mypal[names(mypal) %in% unique(Cprices$sector)]) +
  theme_pubclean() +
  labs(x = "", y = "CO2 Price (2020$/tCO2)",color="" ) +
  coord_cartesian(ylim = c(0, 1000)) +
  theme(axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8))

p2 <- ggplot(Cprices %>% filter(year > 2015, year < 2070, scenario %in% c("NZ+ETS"),sector=="ETS")) +
  geom_line(mapping = aes(x = year, y = value, group = sector, color = sector),show.legend = F,linewidth=1.5) +
  # geom_point(mapping = aes(x=year,y=value,group = scenario,shape=sector,color=sector),show.legend = F)+
  scale_color_manual(values = mypal[names(mypal) %in% unique(Cprices$sector)]) +
  theme_pubclean() +
  labs(x = "", y = "",color="") +
  coord_cartesian(ylim = c(0, 75)) +
  theme(axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8),panel.border = element_rect(colour = "black", fill=NA, linewidth=1),axis.title=element_blank())

p3 <- ggplot(Cprices %>% filter(year > 2015, year < 2070, scenario %in% c("NZ+RPO+ETS"))) +
  geom_line(mapping = aes(x = year, y = value, group = sector, color = sector),linewidth=1.5) +
  facet_wrap(~scenario, shrink = T, scales = "free") +
  scale_color_manual(values = mypal[names(mypal) %in% unique(Cprices$sector)]) +
  theme_pubclean() +
  labs(x = "", y = "",color="" ) +
  coord_cartesian(ylim = c(0, 1000)) +
  theme(axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8))

p4 <- ggplot(Cprices %>% filter(sector != "refining", year > 2015, year < 2070, scenario %in% c("NZ+RPO+ETS"))) +
  geom_line(mapping = aes(x = year, y = value, group = sector, color = sector),show.legend = F,linewidth=1.5) +
  # geom_point(mapping = aes(x=year,y=value,group = scenario,shape=sector,color=sector),show.legend = F)+
  scale_color_manual(values = mypal[names(mypal) %in% unique(Cprices$sector)]) +
  theme_pubclean() +
  labs(x = "", y = "",color="") +
  coord_cartesian(ylim = c(0, 75)) +
  theme(axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8),panel.border = element_rect(colour = "black", fill=NA, linewidth=1),axis.title=element_blank())

p5 <- ggplot(Cprices %>% filter(year > 2015, year < 2070, scenario %in% c("NZ+CC"),sector!="Non-ETS")) +
  geom_line(mapping = aes(x = year, y = value, group = sector, color = sector),linewidth=1.5) +
  facet_wrap(~scenario, shrink = T, scales = "free") +
  scale_color_manual(values = mypal[names(mypal) %in% unique(Cprices$sector)]) +
  theme_pubclean() +
  labs(x = "", y = "",color="" ) +
  coord_cartesian(ylim = c(0, 1000)) +
  theme(axis.text.x = element_text(size = 8, angle = 45, vjust = 0.8, hjust = 0.8))


p12 <- p1 + inset_element(p2, left = 0.02, bottom = 0.4, right = 0.7, top = 0.95,ignore_tag = T)+plot_annotation(tag_levels = 'A')

p34 <- p3 + inset_element(p4, left = 0.02, bottom = 0.4, right = 0.7, top = 0.95,ignore_tag = T)+ plot_annotation(tag_levels = 'A') & labs(y="")


p1 + inset_element(p2, left = 0.02, bottom = 0.4, right = 0.7, top = 0.95,ignore_tag = T)+plot_annotation(tag_levels = 'A') + p3 + inset_element(p4, left = 0.02, bottom = 0.4, right = 0.7, top = 0.95,ignore_tag = T)+ plot_annotation(tag_levels = 'A') & guides(color = guide_legend(nrow = 2)) & theme(legend.text     = element_text(size = 13),strip.text = element_text(size=13))

library(patchwork)
p12+p5& guides(color = guide_legend(nrow = 2)) & theme(legend.text     = element_text(size = 13),strip.text = element_text(size=13))


ggsave("output_plots/C_prices3.png",
  device = "png", dpi = "print",
  width = 9, height = 6
)

###############fast carbon price plot

fast_cprices <- read_excel("data/fast_cprices.xlsx") %>% 
  pivot_longer(`1990`:`2100`,names_to = "year",values_to = "value") %>% 
  mutate(value = (value * 1.98) / 3.667, Units = "2020$/tCO2")

ggplot(fast_cprices %>% filter(year > 2025 & year < 2070 & market == "Carbon price")) +
  geom_line(mapping = aes(x = year, y = value, group = interaction(market, scenario), color = scenario), linewidth = 1.5) +
  theme_pubclean(base_size = 14) +
  labs(y = "CO2 Price (2020$/tCO2)", x = "", color = "") +
  scale_color_aaas()

ggsave("output_plots/fast_c_price.jpg",
  device = "png", dpi = "print",
  width = 7, height = 5
)
  ```

# Final energy mix by agg sector
```{r}
fe_sector <- all_data %>%
  filter(title == "total final energy by aggregate sector", year > 2010, year < 2075) %>%
  group_by(scenario, year) %>%
  mutate(percent = value / sum(value), percent = percent * 100)

ggplot(fe_sector %>% filter(year %in% c(2020, 2030, 2050, 2070), scenario == "NZ")) +
  geom_bar(mapping = aes(x = scenario, y = percent, fill = sector), stat = "identity") +
  facet_grid(. ~ year) +
  scale_fill_manual(values = mypal[names(mypal) %in% unique(fe_sector$sector)]) +
  theme_bw() +
  labs(x = "", y = "Share of final energy by enduse sector (%)", fill = "category") +
  scale_y_continuous(sec.axis = dup_axis(name = "")) +
  theme(axis.text.x = element_text(size = 6, angle = 45, vjust = 0.8, hjust = 0.8))

ggsave("output_plots/FE_mix.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```

# Final energy mix by fuel
```{r}
fe_fuel <- all_data %>%
  filter(title == "final energy consumption by fuel", year > 2010, year < 2075) %>%
  group_by(scenario, year) %>%
  mutate(percent = value / sum(value), percent = percent * 100)

ggplot(fe_fuel %>% filter(year %in% c(2020, 2050, 2070), scenario %in% c("NZ", "NZ+ETS"))) +
  geom_bar(mapping = aes(x = scenario, y = percent, fill = sector), stat = "identity") +
  facet_grid(. ~ year) +
  scale_fill_manual(values = mypal[names(mypal) %in% unique(fe_fuel$sector)]) +
  theme_bw() +
  labs(x = "", y = "Share of final energy (%)", fill = "category")
#  scale_y_continuous(sec.axis = dup_axis(name = "")) +
#  theme(axis.text.x = element_blank())

ggsave("output_plots/FE_mix_fuel.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```

# Sector energy mix by fuel and tech
```{r}
# Final energy by sector and fuel
fe_by_fuel_sector <- read_excel("data/modelling_results_2023_04_17/fe_by_fuel_sector.xlsx", sheet = "Sheet1") %>%
  mutate(across(c(`1990`:`2095`), as.numeric)) %>%
  mutate(across(c(`1990`:`2095`), ~ round(., digits = 2))) %>%
  pivot_longer(`1990`:`2095`, names_to = "year", values_to = "value") %>%
  separate(
    col = scenario,
    into = c("scenario", "date"),
    sep = ",",
    remove = T
  ) %>%
  select(-date) %>%
  mutate(scenario = gsub(
    x = scenario,
    pattern = "India_",
    replacement = ""
  )) %>%
  mutate(
    sector = mgsub::mgsub(sector,
      pattern = c("iron and steel", "cement", " N fertilizer", "aluminum", "alumina", "refining", "electricity", "N fertilizer"),
      replacement = c("Iron and Steel", "Cement", "Fertilizer", "Aluminium", "Aluminium", "Petroleum Refinery", "Electricity", "Fertilizer")
    )
  ) %>% 
  filter(sector %in% common)

ind_decarb <- fe_by_fuel_sector %>% 
  filter(year %in% c(2030,2050,2065, 2070), 
         sector %in% c("Iron and Steel","Cement","Fertilizer"),
         scenario %in% c("NZ+ETS")) %>% 
  select(scenario,year,technology,sector,value) %>% 
  group_by(scenario,year,sector) %>%  
  mutate(perc=(value/sum(value))*100)

ggplot(ind_decarb) +
  geom_col(mapping = aes(x = year, y = perc, fill = technology, group = technology)) +
  facet_grid(scenario ~ sector) +
  theme_pubclean(base_size = 12) +
  labs(x = "", y = "Share of technology  mix (%)")+
  facet_grid(scenario~sector)+
  scale_fill_ucscgb()
  
ggsave(filename =  "output_plots/sector_disagg.png",
  device = "png", dpi = "print",
  width = 8, height = 5
)

fe_by_fuel_sector_share <- fe_by_fuel_sector %>%
  mutate(input=mgsub::mgsub(input,pattern = c("delivered biomass","delivered coal","wholesale gas","refined liquids industrial","elect_td_ind"),replacement = c("biomass","coal","gas","refined liquids","electricity"))) %>% 
    mutate(input=if_else(input,condition = sector=="Fertilizer" & input=="gas" & technology=="gas CCS",true = "gas CCS",false = input)) %>% 
  mutate(input=if_else(input,condition = sector=="Iron and Steel" & input=="coal" & technology=="BLASTFUR CCS",true = "coal CCS",false = input)) %>% 
    mutate(input=if_else(input,condition = sector=="Iron and Steel" & input=="coal" & technology=="EAF with DRI CCS",true = "coal CCS", false = input)) %>% 
   mutate(input=if_else(input,condition = sector=="Iron and Steel" & input=="refined liquids" & technology=="BLASTFUR CCS",true = "refined liquids CCS",false = input)) %>% 
     mutate(input=if_else(input,condition = sector=="Iron and Steel" & input=="refined liquids" & technology=="EAF with DRI CCS", true = "refined liquids CCS", false = input)) %>% 
   mutate(input=if_else(input,condition = sector=="Iron and Steel" & input=="gas" & technology=="EAF with DRI CCS",true = "gas CCS",false = input)) %>% 
  group_by(scenario, sector, year, input) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  group_by(sector, year, scenario) %>%
  mutate(
    perc = value / sum(value) * 100
 )  %>% 
  ungroup() %>%
      mutate(scenario=gsub(x = scenario, pattern = c("NZ+ETS"),replacement = c("With ETS"))) %>% 
  add_row(scenario = "NZ", sector = "Fertilizer", year = "2020", input = "electricity", value = 0, perc = 0) %>%
  add_row(scenario = "NZ", sector = "Fertilizer", year = "2040", input = "electricity", value = 0, perc = 0) %>%
  add_row(scenario = "NZ", sector = "Fertilizer", year = "2070", input = "electricity", value = 0, perc = 0)


ggplot(fe_by_fuel_sector_share %>% filter(year %in% c(2030,2050, 2070), sector %in% common, scenario %in% c("NZ","NZ+ETS"))) +
  geom_col(mapping = aes(x = year, y = perc, fill = input, group = input))+
  facet_grid(scenario ~ sector) +
  theme_pubclean(base_size = 12) +
  labs(x = "", y = "Share of fuel in energy mix (%)")+
  scale_fill_manual(
    values = mypal[names(mypal) %in% unique(fe_by_fuel_sector_share$input)]) +
  theme(legend.position = "top", axis.text.x = element_text(size = 10, angle = 45, vjust = 0.8, hjust = 0.8),strip.text = element_text(size=14),legend.text = element_text(size = 14),legend.title = element_blank())

ggsave(filename =  "output_plots/final_energy_fuel_NZ.png",
  device = "png", dpi = "print",
  width = 8, height = 5
)

```

# Share of hydrogen, electricity, and CCS in FE
```{r}
# share of H2 plot
cd <- ggplot(fe_by_fuel_sector_share %>% filter(year %in% c(2020, 2040, 2065, 2070), sector %in% common, input == "H2")) +
  geom_line(mapping = aes(x = year, y = perc, color = sector, group = interaction(sector, scenario)), show.legend = F) +
  geom_point(mapping = aes(x = year, y = perc, color = sector, shape = sector, group = interaction(sector, scenario)), size = 3) +
  facet_wrap(~scenario, scales = "free") +
  scale_color_lancet() +
  theme_bw() +
  labs(subtitle = "Share of hydrogen \n in final energy (%)", x = "", y = "")

# Share of Electricity plot
ef <- ggplot(fe_by_fuel_sector_share %>% filter(year %in% c(2020, 2040, 2065, 2070), sector %in% common, input == "elect_td_ind", scenario == "NZ")) +
  geom_line(mapping = aes(x = year, y = perc, color = sector, group = interaction(sector, scenario)), show.legend = F) +
  geom_point(mapping = aes(x = year, y = perc, color = sector, shape = sector, group = interaction(sector, scenario)), size = 3, show.legend = F) +
  # facet_wrap(~sector,scales = "free")+
  scale_color_lancet() +
  theme_bw() +
  labs(subtitle = "Share of electricity \n in final energy (%)", x = "", y = "") +
  coord_cartesian(ylim = c(0, 100))

# Share of CCS plot
ccs_share <- fe_by_fuel_sector %>%
  group_by(sector, scenario, technology, year) %>%
  summarise(value = sum(value)) %>%
  group_by(sector, year, scenario) %>%
  mutate(perc = value / sum(value) * 100) %>%
  ungroup() %>%
  filter(technology %in% grep(technology, pattern = "CCS", value = T)) %>%
  # mutate(year=as.numeric(year)) %>%
  group_by(sector, scenario, year) %>%
  summarise(perc = sum(perc))

gh <- ggplot(ccs_share %>% filter(sector %in% common, year %in% c(2020, 2040, 2070), scenario %in% c("NZ","NZ+ETS"))) +
  geom_line(mapping = aes(x = year, y = perc, color = sector, group = interaction(sector, scenario)), show.legend = F) +
  geom_point(mapping = aes(x = year, y = perc, color = sector, shape = sector, group = interaction(sector, scenario)), size = 3) +
  scale_color_manual(values = mypal[names(mypal) %in% unique(ccs_share$sector)]) +
  theme_bw() +
  facet_grid(. ~ scenario) +
  labs(subtitle = "Share of CCS technologies \n in final energy (%)", x = "", y = "") +
  coord_cartesian(ylim = c(0, 100))








  library(patchwork)
gh + plot_layout(guides = "collect") & theme(plot.subtitle = element_text(size = 9))

ggsave("output_plots/share_h2_elec_CCS.png",
  device = "png", dpi = "print",
  width = 8, height = 5
)
```

# Final energy mix of industry sector
```{r}
fe_by_fuel_sector_mix <- fe_by_fuel_sector %>%
  filter(year > 2010, year < 2075) %>%
  group_by(Units, scenario, input, year) %>%
  summarise(value = sum(value)) %>%
  ungroup() %>%
  group_by(scenario, year) %>%
  mutate(percent = value / sum(value), percent = percent * 100)

ggplot(fe_by_fuel_sector_mix %>% filter(year %in% c(2020, 2030, 2050, 2070), scenario == "NZ")) +
  geom_bar(mapping = aes(x = scenario, y = percent, fill = input), stat = "identity") +
  facet_grid(. ~ year) +
  scale_fill_manual(values = mypal[names(mypal) %in% unique(fe_by_fuel_sector_mix$input)]) +
  theme_pubclean() +
  labs(x = "", y = "", subtitle = "Share of final energy in industry (%)", fill = "category") +
  scale_y_continuous(sec.axis = dup_axis(name = "")) +
  theme(axis.text.x = element_text(size = 6, angle = 45, vjust = 0.8, hjust = 0.8))

ggsave("output_plots/FE_INdustry_mix.png",
  device = "png", dpi = "print",
  width = 8, height = 6
)
```


# Inter-sectoral financial transfers and auction revenue
```{r}
sheets <- as.character(seq(2030, 2065, 5))

sheet_list <- list()

list_all <- lapply(sheets, function(x) { # Read all sheets to list
  as.data.frame(read_excel("data/Auctioning_sheet.xlsx", sheet = x))
})

transfers <- do.call(rbind, list_all) %>% 
  mutate(Sectors = mgsub::mgsub(Sectors,pattern = c("iron and steel","cement","N fertilizer","electricity"),replacement = c("Iron and Steel","Cement","Fertilizer","Electricity")))

Cprices <- all_data %>%
  filter(title == "CO2 prices") %>%
  mutate(value = (value * 1.98) / 3.667, Units = "2020$/tCO2") %>% 
  mutate(sector = gsub(sector, pattern = "ETS", replacement = "CO2 (ETS)"),
  sector = if_else(scenario=="NZ+ETS",gsub(sector, pattern = "IndiaCO2\\b", replacement = "Shadow carbon price (non-ETS)"),"Shadow carbon price"),
    sector = mgsub::mgsub(sector, pattern = c("IndiaCO2", "All","Elec", "Fert", "IRSTL"), replacement = c("", "", "Electricity", "Fertilizer", "Iron and Steel"
  )))
  
ets_price <- Cprices %>%
  filter(scenario == "NZ+ETS", year %in% c(2025:2070), sector == "CO2 (ETS)") %>%
  mutate(value = value, Units = "$2020/CO2",year=as.numeric(year))

transfers2 <- left_join(transfers,ets_price,by="year") %>% mutate(fin_transfer=`Surplus Allowances` *3.667* value) %>% 
  mutate(year=as.factor(year))

ggplot(transfers2 %>% filter(year<2055)) +
  geom_col(mapping = aes(x = year, y = fin_transfer/1000 , fill = Sectors, group = Sectors)) +
 scale_fill_manual(values = mypal[names(mypal) %in% unique(transfers$Sectors)]) +
  theme_pubclean(base_size = 14) +
  facet_wrap(~scenario.x) +
  labs(x = "", y = "Financial transfers (billion USD)", fill = "")+
  theme(legend.text = element_text(size = 14),strip.text = element_text(size = 14))

ggsave("output_plots/sectoral_transfers.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```

# Auctioning revenue
```{r}

em_sec <- all_data %>%
  filter(title %in% grep(x = title, pattern = "emissions by sector", value = T)) %>%
  mutate(value = if_else(scenario != "NZ", value / 2, value))

power_ets <- em_sec %>%
  filter(
    sector == "Electricity",
    scenario %in% c("NZ+ETS"), year %in% c(2025:2070)
  ) %>%
  mutate(value = value * 3.67, Units = "MTCO2")

ets_price <- Cprices %>%
  filter(scenario == "NZ+ETS", year %in% c(2025:2070), sector == "CO2 (ETS)") %>%
  mutate(value = value, Units = "$2020/CO2")

scenarios <- data.frame(year = as.character(seq(2025, 2070, 5)), Power_2040 = c(0, 0.1, 0.5, rep(1, 7)), Power_2050 = c(0, 0.1, 0.25, 0.5, 0.75, 1, rep(1, 4)))

revenue <- left_join(left_join(power_ets, ets_price, by = c("year","scenario")), scenarios, by = "year") %>% 
  mutate(Power_2040=value.x*value.y*Power_2040,
         Power_2050=value.x*value.y*Power_2050) %>% 
  select(scenario, year, Power_2040, Power_2050) %>%
  pivot_longer(c(3:4), names_to = "scenario.x", values_to = "value")

ggplot() +
  geom_line(revenue %>% filter(year < 2070, scenario=="NZ+ETS") %>% mutate(value = value / 1000), mapping = aes(x = year, y = value, color = scenario.x,  group = interaction(scenario.x, scenario)), linewidth = 1.5) +
  labs(
    x = "", y = "Auctioning revenue (billion dollars, 2020$)", color = "",subtitle =   "NZ+ETS scenario"
  ) +
  scale_color_uchicago()+
  theme_pubclean(base_size  = 14)+
  theme(legend.text = element_text(size = 14))

ggsave("output_plots/revenue.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```




# Power generation costs
```{r}
gen_costs <- all_data %>%
  filter(title == "elec gen costs by subsector") %>%
  mutate(value = value * 4.8, Units = "2020$/GJ", label = sector) %>%
  filter(year %in% c(2020:2050), !sector %in% c("refined liquids", "geothermal", "nuclear"))

ggplot(gen_costs) +
  geom_textline(mapping = aes(x = year, y = value, label = label, color = label, group = sector), size = 2, hjust = 0.6, vjust = 0.2) +
  facet_wrap(~scenario) +
  theme_bw() +
  theme(legend.position = "none", strip.background = element_blank()) +
  scale_color_manual(values = mypal[names(mypal) %in% unique(gen_costs$label)]) +
  labs(x = "", y = "Generation costs (USD2020/GJ)")

ggsave("output_plots/gen_costs.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```

# Fuel prices to industry
```{r}
fuel_prices <- all_data %>%
  filter(title == "fuel prices to industry") %>%
  mutate(value = value * 4.8, Units = "2020$/GJ") %>%
  filter(year %in% c(2020:2050)) %>%
  mutate(
    sector =
      mgsub::mgsub(sector, pattern = c(
        "H2 industrial",
        "elect_td_ind", "refined liquids industrial", "delivered biomass", "wholesale gas", "delivered coal"
      ), replacement = c("hydrogen", "elect_td_ind", "refined liquids", "biomass", "gas", "coal")), label = sector
  )

ggplot(fuel_prices) +
  geom_textline(mapping = aes(x = year, y = value, label = label, color = label, group = sector), size = 2, hjust = 0.6, vjust = 0.2) +
  facet_wrap(~scenario) +
  theme_bw() +
  theme(legend.position = "none", strip.background = element_blank()) +
  scale_color_manual(values = mypal[names(mypal) %in% unique(fuel_prices$label)]) +
  labs(x = "", y = "Fuel price to industry (USD2020/GJ)")

ggsave("output_plots/fuel_prices2industry.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)
```
# Cost of key technologies
```{r}

tech_cost <- read_delim("data/tech_cost.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(scenario = col_skip(), 
        region = col_skip(), 
        ...25 = col_skip()), trim_ws = TRUE, 
    skip = 1) %>% 
  pivot_longer(cols = `1990`:`2095`,names_to = "year",values_to = "value") %>% 
  mutate(value=value*4.8,
         Units=gsub(Units,pattern = "1975",replacement = "2020"),label=technology) 

elec_techs <- c("coal (conv pul)","oal (conv pul CCS)","gas (CC)","gas (CC CCS)","PV","wind","CSP","biomass (conv)", "rooftop_pv", "Gen_III", "coal (IGCC)", "hydro", "wind_offshore", "biomass (IGCC)","coal (IGCC CCS)","biomass (conv CCS)","biomass (IGCC CCS)","geothermal")

# Electricity costs
ggplot(tech_cost %>% filter(sector=="electricity",input=="capital",year>2015,year<2075,technology %in% elec_techs))+
  geom_line(mapping = aes(x=year,y=value,color=technology,group=technology),linewidth=1.5)+
  scale_color_igv()+
  theme_bw()+
  labs(y="Capital cost (2020$/GJ)",title = "Capital costs of selected technologies")

ggsave("output_plots/Elec_capital_cost.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

# Iron and steel
ggplot(tech_cost %>% filter(sector=="iron and steel", input=="non-energy",year>2015,year<2075,technology!="Biomass-based"))+
  geom_line(mapping = aes(x=year,y=value,color=technology,group=technology),linewidth=1.5)+
  scale_color_igv()+
  theme_bw()+
  labs(y="Capital cost (2020$/kg)",title = "Iron and Steel")

ggsave("output_plots/IRNSTL_capital_cost.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

# Cement
ggplot(tech_cost %>% filter(sector=="cement", input=="non-energy",year>2015,year<2075))+
  geom_line(mapping = aes(x=year,y=value,color=technology,group=technology),linewidth=1.5)+
  scale_color_igv()+
  theme_bw()+
  labs(y="Capital cost (2020$/kg)",title = "Cement")

ggsave("output_plots/Cement_capital_cost.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

# N fertiliser
ggplot(tech_cost %>% filter(sector=="N fertilizer", input=="non-energy",year>2015,year<2075))+
  geom_line(mapping = aes(x=year,y=value,color=technology,group=technology),linewidth=1.5)+
  scale_color_igv()+
  theme_bw()+
  labs(y="Capital cost (2020$/kg)",title = "N fertilizer")


ggsave("output_plots/Fert_capital_cost.png",
  device = "png", dpi = "print",
  width = 7, height = 5
)

```


